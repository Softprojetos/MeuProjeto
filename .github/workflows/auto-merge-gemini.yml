name: Auto-merge after Gemini Review

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Check open PRs for Gemini review
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner, repo: context.repo.repo, state: 'open'
            });

            for (const pr of prs) {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.number
              });

              const geminiReview = comments.find(c =>
                c.user.login === 'gemini-code-assist[bot]' && c.body.includes('Summary of Changes')
              );
              if (!geminiReview) continue;

              const alreadyProcessed = comments.find(c =>
                c.user.login === 'github-actions[bot]' && (c.body.includes('Auto-merge') || c.body.includes('merged'))
              );
              if (alreadyProcessed) continue;

              const { data: reviewComments } = await github.rest.pulls.listReviewComments({
                owner: context.repo.owner, repo: context.repo.repo, pull_number: pr.number
              });
              const geminiIssues = reviewComments.filter(c => c.user.login === 'gemini-code-assist[bot]');
              const issueText = geminiIssues.map(c => c.body).join(' ').toLowerCase();
              const blocking = ['bug','critical','security','vulnerability','injection','xss','credential','hardcoded secret','data leak'];
              const hasBlocking = blocking.some(kw => issueText.includes(kw)) && geminiIssues.length > 0;

              if (hasBlocking) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.number,
                  body: `⚠️ **Auto-merge bloqueado** — Gemini encontrou ${geminiIssues.length} problema(s).`
                });
                continue;
              }

              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner, repo: context.repo.repo, pull_number: pr.number, merge_method: 'squash'
                });
                try { await github.rest.git.deleteRef({ owner: context.repo.owner, repo: context.repo.repo, ref: `heads/${pr.head.ref}` }); } catch(e) {}
                console.log(`PR #${pr.number} merged`);
              } catch(e) {
                console.log(`Could not merge #${pr.number}: ${e.message}`);
              }
            }
